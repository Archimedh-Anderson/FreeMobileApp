name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: D√©ploiement sur EC2
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: üì• Checkout du code
      uses: actions/checkout@v4
    
    - name: üêç Configuration Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ‚úÖ V√©rification de la syntaxe
      run: |
        python -m py_compile streamlit_app/app.py
        echo "‚úÖ Syntaxe Python valid√©e"
    
    - name: üöÄ D√©ploiement via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        command_timeout: 30m
        script_stop: true
        script: |
          set -e
          echo "=================================================="
          echo "üöÄ D√âMARRAGE DU D√âPLOIEMENT - $(date)"
          echo "=================================================="
          
          # Navigation vers le r√©pertoire de l'application
          cd /home/ec2-user/FreeMobileApp
          
          # Sauvegarde de l'√©tat actuel
          echo "üì¶ Sauvegarde de l'√©tat actuel..."
          git stash
          
          # R√©cup√©ration des derni√®res modifications
          echo "‚¨áÔ∏è R√©cup√©ration des modifications..."
          git fetch origin main
          git reset --hard origin/main
          
          # V√©rification de la version
          echo "üìå Version d√©ploy√©e: $(git rev-parse --short HEAD)"
          
          # Installation/mise √† jour des d√©pendances
          echo "üì¶ Installation des d√©pendances..."
          cd streamlit_app
          
          # Cr√©ation du venv s'il n'existe pas
          if [ ! -d "venv" ]; then
            echo "Cr√©ation de l'environnement virtuel..."
            python3 -m venv venv
          fi
          
          # Activation du venv
          source venv/bin/activate
          
          # Mise √† jour de pip
          pip install --upgrade pip --quiet
          
          # Installation des d√©pendances
          pip install -r requirements.txt --upgrade --quiet
          
          # V√©rification de la configuration
          if [ ! -f .env ]; then
            echo "‚ö†Ô∏è Fichier .env manquant - utilisation des valeurs par d√©faut"
          fi
          
          # Red√©marrage du service Streamlit
          echo "üîÑ Red√©marrage du service Streamlit..."
          sudo systemctl restart streamlit.service
          
          # Attente du d√©marrage
          sleep 5
          
          # V√©rification du statut du service
          if sudo systemctl is-active --quiet streamlit.service; then
            echo "‚úÖ Service Streamlit d√©marr√© avec succ√®s"
            sudo systemctl status streamlit.service --no-pager --lines=0
          else
            echo "‚ùå ERREUR: Le service Streamlit n'a pas d√©marr√© correctement"
            sudo journalctl -u streamlit.service -n 50 --no-pager
            exit 1
          fi
          
          # Test de connectivit√© HTTP
          echo "üåê Test de connectivit√©..."
          if curl -f http://localhost:8502 > /dev/null 2>&1; then
            echo "‚úÖ Application accessible sur le port 8502"
          else
            echo "‚ö†Ô∏è Application non accessible via HTTP (v√©rifiez le firewall)"
          fi
          
          # V√©rification des processus Streamlit
          if pgrep -f "streamlit run" > /dev/null; then
            echo "‚úÖ Processus Streamlit en cours d'ex√©cution"
          else
            echo "‚ö†Ô∏è Aucun processus Streamlit trouv√©"
          fi
          
          echo "=================================================="
          echo "‚úÖ D√âPLOIEMENT TERMIN√â AVEC SUCC√àS - $(date)"
          echo "=================================================="
    
    - name: ‚úÖ Notification de succ√®s
      if: success()
      run: |
        echo "::notice::üéâ D√©ploiement r√©ussi sur EC2 (13.37.186.191:8502)"
    
    - name: ‚ùå Notification d'√©chec
      if: failure()
      run: |
        echo "::error::üí• √âchec du d√©ploiement - V√©rifiez les logs ci-dessus"
