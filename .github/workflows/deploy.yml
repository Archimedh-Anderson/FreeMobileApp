name: Deploy to AWS EC2

# D√©clenchement automatique sur push vers la branche main
on:
  push:
    branches:
      - main
  # Permet √©galement un d√©clenchement manuel depuis l'interface GitHub
  workflow_dispatch:

jobs:
  deploy:
    name: D√©ploiement sur EC2
    runs-on: ubuntu-latest
    
    steps:
      # 1. R√©cup√©ration du code source
      - name: üì• Checkout du code
        uses: actions/checkout@v4
        
      # 2. V√©rification de la syntaxe Python (optionnel mais recommand√©)
      - name: üêç Configuration Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: ‚úÖ V√©rification de la syntaxe
        run: |
          python -m py_compile streamlit_app/app.py
          echo "‚úÖ Syntaxe Python valid√©e"
      
      # 3. Connexion SSH et d√©ploiement sur EC2
      - name: üöÄ D√©ploiement via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script_stop: true  # Arr√™te si une commande √©choue
          script: |
            echo "=================================================="
            echo "üöÄ D√âMARRAGE DU D√âPLOIEMENT - $(date)"
            echo "=================================================="
            
            # Navigation vers le r√©pertoire de l'application
            cd /home/ec2-user/FreeMobileApp
            
            # Sauvegarde de l'√©tat actuel
            echo "üì¶ Sauvegarde de l'√©tat actuel..."
            git stash
            
            # R√©cup√©ration des derni√®res modifications
            echo "‚¨áÔ∏è  R√©cup√©ration des modifications..."
            git fetch origin main
            git reset --hard origin/main
            
            # V√©rification de la version
            echo "üìå Version d√©ploy√©e: $(git rev-parse --short HEAD)"
            
            # Installation/mise √† jour des d√©pendances
            echo "üì¶ Installation des d√©pendances..."
            cd streamlit_app
            python3 -m pip install --upgrade pip --quiet
            python3 -m pip install -r requirements.txt --quiet
            
            # V√©rification de la configuration
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è  Fichier .env manquant - utilisation des valeurs par d√©faut"
            fi
            
            # Red√©marrage du service Streamlit avec journalisation
            echo "üîÑ Red√©marrage du service Streamlit..."
            sudo systemctl restart streamlit.service
            
            # Attente du d√©marrage (5 secondes)
            sleep 5
            
            # V√©rification du statut du service
            if sudo systemctl is-active --quiet streamlit.service; then
              echo "‚úÖ Service Streamlit d√©marr√© avec succ√®s"
              sudo systemctl status streamlit.service --no-pager
            else
              echo "‚ùå ERREUR: Le service Streamlit n'a pas d√©marr√© correctement"
              sudo journalctl -u streamlit.service -n 50 --no-pager
              exit 1
            fi
            
            # Affichage des derni√®res lignes de log
            echo "üìã Derni√®res lignes de log:"
            sudo tail -n 20 /var/log/streamlit.log || echo "‚ö†Ô∏è  Fichier de log non accessible"
            
            echo "=================================================="
            echo "‚úÖ D√âPLOIEMENT TERMIN√â AVEC SUCC√àS - $(date)"
            echo "=================================================="
      
      # 4. Notification en cas de succ√®s
      - name: ‚úÖ Notification de succ√®s
        if: success()
        run: |
          echo "::notice::üéâ D√©ploiement r√©ussi sur EC2 (13.37.186.191)"
          
      # 5. Notification en cas d'√©chec
      - name: ‚ùå Notification d'√©chec
        if: failure()
        run: |
          echo "::error::üí• √âchec du d√©ploiement - V√©rifiez les logs ci-dessus"

# NOTES IMPORTANTES:
# 
# SECRETS GITHUB √Ä CONFIGURER:
# - EC2_HOST: 13.37.186.191
# - EC2_USERNAME: ec2-user
# - EC2_SSH_KEY: Votre cl√© priv√©e SSH compl√®te (incluant -----BEGIN RSA PRIVATE KEY-----)
#
# PR√âREQUIS SUR EC2:
# - Git install√©
# - Python 3.11+ install√©
# - Service systemd streamlit.service configur√©
# - Permissions sudo sans mot de passe pour: systemctl restart streamlit.service
#
# COMMANDES UTILES:
# - Voir les logs GitHub Actions: onglet "Actions" du repository
# - Voir les logs EC2: sudo journalctl -u streamlit.service -f
# - Tester manuellement: cd /home/ec2-user && bash deploy.sh
