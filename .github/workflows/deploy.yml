name: Deploy to EC2

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key for EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # Add EC2 to known_hosts to avoid prompts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: "üîç Pre-Deployment Diagnostics"
        run: |
          echo "=========================================="
          echo "üöÄ DEPLOYMENT DIAGNOSTICS"
          echo "=========================================="
          echo "üìÖ Timestamp: $(date -u)"
          echo "üîÄ Branch: ${{ github.ref_name }}"
          echo "üíæ Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"
          echo "üìù Message: ${{ github.event.head_commit.message }}"
          echo "üè∑Ô∏è  Trigger: ${{ github.event_name }}"
          echo "=========================================="

      - name: "üîó Test EC2 Connectivity"
        run: |
          echo "Testing SSH connection to EC2..."
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            echo '‚úÖ SSH Connection successful'
            echo 'üìä System Info:'
            uname -a
            echo 'üíª CPU & Memory:'
            free -h
            echo 'üíæ Disk Usage:'
            df -h / | tail -1
            echo '‚è∞ System Time:'
            date
          ENDSSH

      - name: "üì¶ Deploy Application to EC2"
        run: |
          echo "=========================================="
          echo "üöÄ STARTING DEPLOYMENT"
          echo "=========================================="

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e  # Exit on any error
            
            # Configuration
            APP_DIR="/home/ec2-user/FreeMobileApp"
            SERVICE_NAME="streamlit.service"
            
            # Pre-deployment: Check current service status
            echo "=========================================="
            echo "üîç PRE-DEPLOYMENT HEALTH CHECK"
            echo "=========================================="
            if sudo systemctl is-active --quiet ${SERVICE_NAME} 2>/dev/null; then
              echo "‚úÖ Service is currently running"
            else
              echo "‚ö†Ô∏è Service is not currently running (may be first deployment)"
            fi
            
            # Navigate to app directory
            echo ""
            echo "üìÇ Navigating to application directory..."
            if [ ! -d "${APP_DIR}" ]; then
              echo "‚ùå Directory ${APP_DIR} not found"
              echo "Creating directory..."
              mkdir -p ${APP_DIR}
              echo "Directory created, but repository needs to be cloned manually first"
              exit 1
            fi
            
            cd ${APP_DIR}
            echo "‚úÖ Current directory: $(pwd)"
            
            # Check if git repository exists
            if [ ! -d ".git" ]; then
              echo "‚ùå Not a git repository. Please clone the repository first:"
              echo "   git clone https://github.com/Archimedh-Anderson/FreeMobileApp.git ${APP_DIR}"
              exit 1
            fi
            
            # Pull latest code
            echo ""
            echo "=========================================="
            echo "üì• FETCHING LATEST CHANGES"
            echo "=========================================="
            echo "üì• Fetching from origin..."
            git fetch origin main || {
              echo "‚ùå Failed to fetch from repository"
              echo "Checking git remote configuration..."
              git remote -v || true
              exit 1
            }
            
            echo "üîÑ Pulling latest code..."
            git pull origin main || {
              echo "‚ùå Failed to pull code from repository"
              echo "Current git status:"
              git status || true
              exit 1
            }
            
            echo ""
            echo "üìã Current commit:"
            git log -1 --oneline
            
            # Navigate to streamlit_app
            echo ""
            echo "üìÇ Navigating to streamlit_app directory..."
            cd streamlit_app || {
              echo "‚ùå streamlit_app directory not found"
              exit 1
            }
            
            # Create venv if it doesn't exist
            if [ ! -d "venv" ]; then
              echo ""
              echo "=========================================="
              echo "üêç CREATING VIRTUAL ENVIRONMENT"
              echo "=========================================="
              python3 -m venv venv
              echo "‚úÖ Virtual environment created"
            else
              echo "‚úÖ Virtual environment already exists"
            fi
            
            # Activate venv
            echo ""
            echo "=========================================="
            echo "üîå ACTIVATING VIRTUAL ENVIRONMENT"
            echo "=========================================="
            source venv/bin/activate
            echo "‚úÖ Virtual environment activated"
            echo "Python version: $(python3 --version)"
            echo "Pip version: $(pip --version)"
            
            # Upgrade pip
            echo ""
            echo "=========================================="
            echo "‚¨ÜÔ∏è  UPGRADING PIP"
            echo "=========================================="
            python3 -m pip install --upgrade pip --quiet
            echo "‚úÖ Pip upgraded"
            
            # Install/update dependencies
            echo ""
            echo "=========================================="
            echo "üì¶ INSTALLING DEPENDENCIES"
            echo "=========================================="
            if [ ! -f "requirements.txt" ]; then
              echo "‚ùå requirements.txt not found in streamlit_app directory"
              exit 1
            fi
            echo "Installing from requirements.txt..."
            pip install -r requirements.txt --upgrade --no-cache-dir || {
              echo "‚ùå Failed to install dependencies"
              exit 1
            }
            echo "‚úÖ Dependencies installed successfully"
            
            # Reload systemd daemon (critical after service file changes)
            echo ""
            echo "=========================================="
            echo "üîÑ RELOADING SYSTEMD CONFIGURATION"
            echo "=========================================="
            sudo systemctl daemon-reload || {
              echo "‚ö†Ô∏è Warning: daemon-reload failed (service may not exist yet)"
            }
            echo "‚úÖ Systemd daemon reloaded"
            
            # Stop service before deployment (graceful shutdown)
            echo ""
            echo "=========================================="
            echo "üõë STOPPING STREAMLIT SERVICE"
            echo "=========================================="
            if sudo systemctl is-active --quiet ${SERVICE_NAME} 2>/dev/null; then
              sudo systemctl stop ${SERVICE_NAME} || {
                echo "‚ö†Ô∏è Warning: Failed to stop service (may not be running)"
              }
              echo "‚è≥ Waiting for graceful shutdown (2s)..."
              sleep 2
              echo "‚úÖ Service stopped"
            else
              echo "‚ÑπÔ∏è  Service was not running"
            fi
            
            # Check if service file exists, create if missing
            echo ""
            echo "=========================================="
            echo "üîç CHECKING/CREATING SERVICE FILE"
            echo "=========================================="
            if [ ! -f "/etc/systemd/system/${SERVICE_NAME}" ]; then
              echo "‚ö†Ô∏è Service file /etc/systemd/system/${SERVICE_NAME} not found"
              echo "Creating service file..."
              
              # Determine Python and Streamlit paths
              PYTHON_PATH=$(which python3)
              STREAMLIT_PATH=$(which streamlit)
              if [ -z "$STREAMLIT_PATH" ] && [ -f "${APP_DIR}/streamlit_app/venv/bin/streamlit" ]; then
                STREAMLIT_PATH="${APP_DIR}/streamlit_app/venv/bin/streamlit"
              fi
              
              # Create service file
              sudo tee /etc/systemd/system/${SERVICE_NAME} > /dev/null << EOF
[Unit]
Description=Streamlit FreeMobileApp
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=${APP_DIR}/streamlit_app
Environment="PATH=${APP_DIR}/streamlit_app/venv/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=${APP_DIR}/streamlit_app/venv/bin/streamlit run app.py --server.port 8502 --server.address 0.0.0.0
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
              
              echo "‚úÖ Service file created"
              sudo systemctl daemon-reload
              # Enable service for auto-start
              sudo systemctl enable ${SERVICE_NAME} || echo "‚ö†Ô∏è Failed to enable service (non-critical)"
            else
              echo "‚úÖ Service file exists"
            fi
            
            # Ensure service is enabled for auto-start
            if ! sudo systemctl is-enabled ${SERVICE_NAME} --quiet 2>/dev/null; then
              echo "Enabling service for auto-start..."
              sudo systemctl enable ${SERVICE_NAME} || echo "‚ö†Ô∏è Failed to enable service (non-critical)"
            fi
            
            # Start streamlit service
            echo ""
            echo "=========================================="
            echo "‚ñ∂Ô∏è  STARTING STREAMLIT SERVICE"
            echo "=========================================="
            if sudo systemctl start ${SERVICE_NAME} 2>&1; then
              echo "‚úÖ Service start command executed"
            else
              START_ERROR=$?
              echo "‚ùå Failed to start service (exit code: $START_ERROR)"
              echo ""
              echo "=== Service file check ==="
              sudo cat /etc/systemd/system/${SERVICE_NAME} 2>/dev/null || echo "Service file not readable"
              echo ""
              echo "=== Service logs ==="
              sudo journalctl -u ${SERVICE_NAME} -n 50 --no-pager || true
              echo ""
              echo "=== Systemd status ==="
              sudo systemctl status ${SERVICE_NAME} --no-pager || true
              exit 1
            fi
            
            # Wait for service to fully start
            echo ""
            echo "‚è≥ Waiting for service to initialize (5s)..."
            sleep 5
            
            # Retry logic for service activation check
            echo ""
            echo "=========================================="
            echo "üîç VERIFYING SERVICE ACTIVATION"
            echo "=========================================="
            MAX_RETRIES=3
            RETRY_COUNT=0
            SERVICE_ACTIVE=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if sudo systemctl is-active --quiet ${SERVICE_NAME}; then
                SERVICE_ACTIVE=true
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "‚è≥ Service not active yet, retry $RETRY_COUNT/$MAX_RETRIES..."
              sleep 3
            done
            
            # Final service status check
            if [ "$SERVICE_ACTIVE" = true ]; then
              echo "‚úÖ Service is ACTIVE"
              echo ""
              echo "üìä Service status:"
              sudo systemctl status ${SERVICE_NAME} --no-pager --lines=5
            else
              echo "‚ùå Deployment failed! Service is not running after $MAX_RETRIES retries."
              echo ""
              echo "=== Service status ==="
              sudo systemctl status ${SERVICE_NAME} --no-pager || true
              echo ""
              echo "=== Recent service logs ==="
              sudo journalctl -u ${SERVICE_NAME} -n 50 --no-pager || true
              exit 1
            fi
            
            echo ""
            echo "=========================================="
            echo "üéâ DEPLOYMENT COMPLETED"
            echo "=========================================="
          ENDSSH

          echo "=========================================="
          echo "üéâ DEPLOYMENT COMPLETED"
          echo "=========================================="

      - name: "üîç Monitor Service Status"
        run: |
          echo "=========================================="
          echo "üìä SERVICE STATUS DIAGNOSTICS"
          echo "=========================================="

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            echo "üîç Checking service active status..."
            sudo systemctl is-active streamlit.service || echo "‚ö†Ô∏è  Service not active"

            echo ""
            echo "üìä Full service status:"
            sudo systemctl status streamlit.service --no-pager || true

            echo ""
            echo "üìú Recent service logs (last 30 lines):"
            sudo journalctl -u streamlit.service -n 30 --no-pager || true

            echo ""
            echo "üîå Port 8502 listening check:"
            sudo netstat -tulpn | grep 8502 || echo "‚ö†Ô∏è  Port 8502 not listening"

            echo ""
            echo "üîç Process check:"
            ps aux | grep streamlit | grep -v grep || echo "‚ö†Ô∏è  No streamlit process found"
          ENDSSH

      - name: "‚úÖ Verify Service is Running"
        run: |
          echo "=========================================="
          echo "‚úÖ VERIFYING SERVICE STATUS"
          echo "=========================================="

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            # Check if service is active
            if sudo systemctl is-active --quiet streamlit.service; then
              echo "‚úÖ Service is ACTIVE"
            else
              echo "‚ùå Service is NOT active"
              sudo systemctl status streamlit.service --no-pager
              exit 1
            fi

            # Check if service is enabled
            if sudo systemctl is-enabled --quiet streamlit.service; then
              echo "‚úÖ Service is ENABLED (will start on boot)"
            else
              echo "‚ö†Ô∏è  Service is not enabled for auto-start"
            fi

            # Verify process is running
            if pgrep -f "streamlit run" > /dev/null; then
              echo "‚úÖ Streamlit process is RUNNING"
              ps aux | grep "streamlit run" | grep -v grep
            else
              echo "‚ùå No Streamlit process found"
              exit 1
            fi
          ENDSSH

      - name: "üè• Health Check - Local (EC2)"
        run: |
          echo "=========================================="
          echo "üè• LOCAL HEALTH CHECK"
          echo "=========================================="

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            echo "‚è≥ Waiting for application to be fully ready (15s)..."
            sleep 15

            echo "üîç Testing local endpoint (localhost:8502)..."

            # Test with curl
            if curl -f -s --max-time 10 http://localhost:8502 > /dev/null; then
              echo "‚úÖ Local endpoint is RESPONDING"

              # Get response headers
              echo ""
              echo "üìä Response headers:"
              curl -I -s http://localhost:8502 | head -n 10

            else
              echo "‚ùå Local endpoint NOT responding"
              echo "Checking logs for errors:"
              sudo journalctl -u streamlit.service -n 50 --no-pager
              exit 1
            fi
          ENDSSH

      - name: "üåê Health Check - External (DuckDNS)"
        run: |
          echo "=========================================="
          echo "üåê EXTERNAL ACCESSIBILITY CHECK"
          echo "=========================================="

          DOMAIN_URL="http://freemobila.duckdns.org:8502/"

          echo "üîç Testing external domain: $DOMAIN_URL"
          echo "‚è≥ Waiting for DNS propagation (10s)..."
          sleep 10

          # Test with curl from GitHub Actions runner (external)
          MAX_RETRIES=5
          RETRY_COUNT=0
          DOMAIN_ACCESSIBLE=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s --max-time 30 "$DOMAIN_URL" > /dev/null 2>&1; then
              DOMAIN_ACCESSIBLE=true
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Domain not accessible, retry $RETRY_COUNT/$MAX_RETRIES..."
            sleep 5
          done
          
          if [ "$DOMAIN_ACCESSIBLE" = true ]; then
            echo "‚úÖ Domain is ACCESSIBLE from external network"
            echo ""
            echo "üìä Domain response info:"
            curl -I -s --max-time 10 "$DOMAIN_URL" | head -n 10
            echo ""
            echo "‚úÖ Application successfully deployed and accessible!"
          else
            echo "‚ö†Ô∏è Domain NOT accessible from external network after $MAX_RETRIES retries"
            echo ""
            echo "üîç Debugging information:"
            echo "1. DNS Resolution:"
            nslookup freemobila.duckdns.org || dig freemobila.duckdns.org || true
            echo ""
            echo "‚ö†Ô∏è  Possible issues:"
            echo "   - Security group not allowing port 8502"
            echo "   - DuckDNS IP not updated"
            echo "   - Streamlit not binding to 0.0.0.0"
            echo "   - Application still starting (may need more time)"
            echo ""
            echo "‚ÑπÔ∏è  This is a warning, not a failure. Service may be accessible but behind firewall."
          fi

      - name: "‚è±Ô∏è Service Stability Test (30s)"
        run: |
          echo "=========================================="
          echo "‚è±Ô∏è  TESTING SERVICE STABILITY"
          echo "=========================================="

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            echo "‚è≥ Monitoring service for 30 seconds..."

            for i in {1..6}; do
              echo "üîç Check $i/6 (${i}x5s)..."

              if sudo systemctl is-active --quiet streamlit.service; then
                echo "  ‚úÖ Service still active"
              else
                echo "  ‚ùå Service stopped unexpectedly!"
                sudo systemctl status streamlit.service --no-pager
                sudo journalctl -u streamlit.service -n 50 --no-pager
                exit 1
              fi

              sleep 5
            done

            echo "‚úÖ Service remained stable for 30 seconds"
          ENDSSH

      - name: "üìã Deployment Summary"
        if: always()
        run: |
          echo "=========================================="
          echo "üìã DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo "üéØ Target: http://freemobila.duckdns.org:8502/"
          echo "üìÖ Completed: $(date -u)"
          echo "üîÄ Branch: ${{ github.ref_name }}"
          echo "üíæ Commit: ${{ github.sha }}"
          echo "üë§ Deployed by: ${{ github.actor }}"
          echo "=========================================="

      - name: "üö® Deployment Failed - Collect Debug Info"
        if: failure()
        run: |
          echo "=========================================="
          echo "‚ùå DEPLOYMENT FAILED - DEBUG INFO"
          echo "=========================================="

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH' || true
            echo "üìú Last 100 lines of service logs:"
            sudo journalctl -u streamlit.service -n 100 --no-pager

            echo ""
            echo "üîç Service status:"
            sudo systemctl status streamlit.service --no-pager || true

            echo ""
            echo "üíª System resources:"
            free -h
            df -h
          ENDSSH